<!DOCTYPE html>
<html><head><meta charset='UTF-8'></meta>
<title>centaurihelp ─ _centauri_bash_pip</title>
<link rel='stylesheet' type='text/css' href='default.css'></link>
<script type='text/javascript' src='default.js'></script>
</head><body><article id='top'>
<nav><div class='nav-row'>
<div class='nav-left'><a href='_centauri_bash_mnt.html'>[&lt;&lt; previous]</a></div>
<div class='nav-mid'><a href='content.html#top'>[Content]</a></div>
<div class='nav-mid'><a href='reference.html#top'>[Reference]</a></div>
<div class='nav-right'><a href='_centauri_bash_pro.html'>[next &gt;&gt;]</a></div>
</div></nav>
<section id='section-1'>
<div id='_centauri_bash_pip' class='item-module'>
<span>Module</span><span> - </span><span>_centauri_bash_pip</span><span> - </span><span><a href="index.html">Centauri Bash Library</a> Coprocess, Pipe and Pager support</span></div>
<div class='def-row'>
<div class='def-label'>Call:</div>
<div class='def-text'>. <b>_centauri_bash_pip</b></div>
</div>
<div class='def-row'>
<div class='def-label'>General:</div>
<div class='def-block'>The module implements three functions that use pipes (fifo) or the bash coproc command:</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-text'>  • <a href="#sysbind">sysbind()</a>  - bind two pipes to a server process, simple RPC calls
  • <a href="#syspager">syspager()</a> - pipe a command&apos;s output through a pager (like less)
  • <a href="#syspipe">syspipe()</a>  - run a command in background using coproc or a pipe</div>
</div>
<div class='def-row'>
<div class='def-label'>Remark:</div>
<div class='def-block'>Copyright Dr. J. Pfennig (c) 2021-2022</div>
</div>
</section>
<section id='section-2'>
<div id='pager' class='item-topic'>
<span>Topic</span><span> - </span><span>Pager</span><span> - </span><span>Using a pager like less or more</span></div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>The library supports a pager via the <a href="_centauri_bash_pip.html">_centauri_bash_pip</a> module. If this module is available at script start time, the option <b>--pager</b> gets enabled automatically and all output from <a href="_centauri_bash_dbg.html#runuser">run()</a> or action handlers can be passed through a pager this way.</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>The easiest method for paging output programmatically (and thereby honoring the <b>--pager</b> option) is using the <b>CEN_PAGER</b> variable. On request the option parser in <a href="_centauri_bash_lib.html#main">main()</a> will load <a href="_centauri_bash_pip.html">_centauri_bash_pip</a> and call <a href="#syspipe">syspipe()</a>:</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'><pre>$<b>CEN_PAGER</b> &lt;worker&gt; &lt;arg&gt;...</pre></div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>The <a href="#syspipe">syspipe()</a> call will set <b>&quot;CEN_PAGER=syspipe&quot;</b> if paging is enabled, or clear <b>CEN_PAGER</b> if paging is off. To enable paging when <b>--pager</b> is not set, use the following code:</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'><pre>embed <b>-q</b> _centauri_bash_pip &amp;&amp; syspipe  # load module and enable
$<b>CEN_PAGER</b> &lt;worker&gt; &lt;arg&gt;...</pre></div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>It is also possible to call <a href="#syspager">syspager()</a> directly, but this will always need to load <a href="_centauri_bash_pip.html">_centauri_bash_pip</a>. In such a case packaged scripts must add this module to the list of packaged modules. Without the module being packed a packaged script will not have the <b>--pager</b> option (see <a href="uglify.html">uglify</a> tool).</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>The <a href="centaurihelp.html">centaurihelp</a> program is used internally as a pager by the library to implement the command line <b>--help</b> option. Unless <b>&quot;--help --pager=off&quot;</b> is used, the <a href="_centauri_bash_use.html#usageuser">usage()</a> function pages the help output through centaurihelp to prettify it.</div>
</div>
</section>
<section id='section-3'>
<div id='sysbind' class='item-function'>
<span>Function</span><span> - </span><span>sysbind</span><span> - </span><span>bind two pipes to an external server process, simple RPC calls</span></div>
<div class='def-row'>
<div class='def-label'>Call:</div>
<div class='def-text'><b>sysbind</b> [<b>-e</b>|<b>-f</b>] [<b>-i</b> <i>inst</i>] <b>-s</b> [<b>-d</b> <i>data</i>] [<b>--</b>] <i>serv</i> <i>arg</i>...
<b>sysbind</b> [<b>-e</b>|<b>-f</b>] [<b>-i</b> <i>inst</i>] <b>-c</b> [<i>name</i>|<b>-</b>] [<b>-a</b> <i>rslt</i>] [<b>-d</b> <i>data</i> | [<b>--</b>] <i>arg</i>...]
<b>sysbind</b> [<b>-e</b>|<b>-f</b>] [<b>-i</b> <i>inst</i>] <b>-t</b></div>
</div>
<div class='def-row'>
<div class='def-label'>Options:</div>
<div class='def-text'><b>-a</b>  destination array for RPC reply
<b>-i</b>  array to keep state in (default: <b>CEN_SYSBIND</b>)
<b>-c</b>  make a RPC call to the server
<b>-d</b>  send data to server
<b>-e</b>  report errors
<b>-f</b>  errors are fatal
<b>-s</b>  open pipes (start server)
<b>-t</b>  close pipes (terminate server)</div>
</div>
<div class='def-row'>
<div class='def-label'>Arguments:</div>
<div class='def-text'><i>arg</i>   arguments for server
<i>inst</i>  instance array, not to be modified by caller
<i>rslt</i>  array to receive server reply</div>
</div>
<div class='def-row'>
<div class='def-label'>Instance:</div>
<div class='def-text'>An array managed by this function, not to be modified by caller</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-text'>  inst[0]     process id of server
  inst[1]     handle for send pipe
  inst[2]     handle for receive pipe
  inst[3]     send fifo name (if any)
  inst[4]     receive fifo name (if any)
  ...         opaque data for internal use</div>
</div>
<div class='def-row'>
<div class='def-label'>Return:</div>
<div class='def-text'><b>true</b> at success or <b>false</b> otherwise.</div>
</div>
<div class='def-row'>
<div class='def-label'>Remark:</div>
<div class='def-block'>The RPC protocol should be text-line based (server replies are split into lines, delimiter is <b>&quot;\n&quot;</b>). The server must only send data in reply to a request. On each request a reply must be send. Server replies must end with a <b>&quot;\n&quot;</b>.</div>
</div>
</section>
<section id='section-4'>
<div id='syspager' class='item-function'>
<span>Function</span><span> - </span><span>syspager</span><span> - </span><span>pipe a command&apos;s output through a pager (like less)</span></div>
<div class='def-row'>
<div class='def-label'>Call:</div>
<div class='def-text'>(1) <b>syspager</b> [<b>-c</b> <i>cmd</i>|<i>path</i>] [<b>-d</b>] [<i>func</i> <i>arg</i>...]
(2) $<b>CEN_PAGER</b> <i>func</i> <i>arg</i>...</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>Form (1) initializes <b>CEN_PAGER</b> and <b>CEN_OPT_PAGER</b>. It optionally also runs <i>func</i> - directly or via pager. Once initialized, option <b>-c</b> has no effect unless combined with <b>-d</b>.</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>Form (2) runs <i>func</i> directly if <b>CEN_PAGER</b> is not set by a command line <b>--pager</b> option or by a prior call to <b>syspager</b>.</div>
</div>
<div class='def-row'>
<div class='def-label'>Options:</div>
<div class='def-text'><b>-c</b>  override pager given by <b>CEN_OPT_PAGER</b>
<b>-d</b>  clear <b>CEN_PAGER</b> and set <b>CEN_OPT_PAGER</b>=&apos;off&apos;</div>
</div>
<div class='def-row'>
<div class='def-label'>Arguments:</div>
<div class='def-text'><i>cmd</i>   pager command: on|off|yes|no|less|more
<i>path</i>  filesystem path of a pager command
<i>func</i>  function to be executed
<i>arg</i>   function argument</div>
</div>
<div class='def-row'>
<div class='def-label'>Return:</div>
<div class='def-text'><b>true</b> at success or <b>false</b> otherwise.</div>
</div>
<div class='def-row'>
<div class='def-label'>Remark:</div>
<div class='def-block'>The implementation of this function uses <a href="#syspipe">syspipe()</a> with default error handling. Passing a large amount of data to the pager, so that the pipe enters blocking state, and then quitting the pager will cause a SIGPIPE error. In turn the error handler will call <a href="_centauri_bash_lib.html#quit">quit()</a> so that <b>syspager</b> does not return, but quit hooks will run.</div>
</div>
</section>
<section id='section-5'>
<div id='syspipe' class='item-function'>
<span>Function</span><span> - </span><span>syspipe</span><span> - </span><span>run a command in background using coproc or a pipe</span></div>
<div class='def-row'>
<div class='def-label'>Call:</div>
<div class='def-text'><b>syspipe</b> ORIGIN [DESTINATION] [<b>-c</b> <i>error</i>|<b>-</b>]
        [<b>-e</b>|<b>-f</b>] [<b>-g</b>] [<b>-n</b>] [<b>-r</b>] [<b>-v</b>] [<b>-x</b>] [<b>-y</b>] <b>--</b> <i>cmd</i> <i>arg</i>...</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-text'>ORIGIN      := <b>-o</b> <i>producer</i> | <b>-i</b> <i>var</i> | <b>-i</b> -
DESTINATION := <b>-d</b> <i>consumer</i> | <b>-a</b> <i>array</i> | <b>-s</b> <i>string</i></div>
</div>
<div class='def-row'>
<div class='def-label'>Options:</div>
<div class='def-text'><b>-a</b>      [*] put output into an array (overrides <b>-c</b>)
<b>-d</b>      [*] destination script function (stdin -&gt; <i>consumer</i>)
<b>-c</b>      error handler (also called from SIGPIPE trap)
<b>-e</b>      error message if check fails, overrides <b>-q</b>, see <b>-n</b>
<b>-f</b>      make errors fatal
<b>-g</b>      accept command exit status=1 as non-error
<b>-i</b>      [*] get input data from array or string (overrides <b>-p</b>)
<b>-n</b>      do not check <i>producer</i>, <i>provider</i> or <i>cmd</i>
<b>-o</b>      [*] origin script function (<i>producer</i> =&gt; stdout)
<b>-r</b>      ignore dryrun
<b>-s</b>      [*] put output into a string variable (overrides <b>-c</b>)
<b>-x</b>      run as &apos;coproc&apos; (can have only one coproc at a time)
<b>-y</b>      redirect stderr of <i>cmd</i> to stdout</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-text'>        [*] These options are mutually exclusive</div>
</div>
<div class='def-row'>
<div class='def-label'>Arguments:</div>
<div class='def-text'><i>cmd</i>       command to be run in background
<i>arg</i>       command argument(s)
<i>error</i>     a custom error handler, use <b>&quot;-&quot;</b> to disable error handling
<i>consumer</i>  [#] script function that produces data for <i>cmd</i>
<i>producer</i>  [#] script function that consumes data from <i>cmd</i>
<i>array</i>     name of an array variable
<i>string</i>    name of a string variable
<i>var</i>       name of a string or array veriable</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-text'>[#] using external commands possibe but not recommended</div>
</div>
<div class='def-row'>
<div class='def-label'>Return:</div>
<div class='def-text'><b>true</b> at success or <b>false</b> otherwise.</div>
</div>
<div class='def-row'>
<div class='def-label'>Coproc:</div>
<div class='def-block'>I/O redirection (and <b>&quot;|&quot;</b> pipes) run the command (or function) in a sub-shell. This makes it difficult to pass lengthy output back to the caller&apos;s context. The bash <b>coproc</b> builtin (see option <b>-x</b>) can mitigate the problem by passing standard input and output of a command to the caller&apos;s context. See the <a href="_centauri_bash_txt.html#extsort">extsort()</a> function for a <b>coproc</b> example.</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>Beware: <b>coproc</b> cannot be nested, but the <b>syspipe</b> implementation can run a <i>producer</i> / <i>consumer</i> pair even without option <b>-x</b> (but at the price of using an temporary file to buffer the <i>cmd</i> output).</div>
</div>
<div class='def-row'>
<div class='def-label'>Fifo:</div>
<div class='def-block'>A temporary fifo is created via <a href="_centauri_bash_ext.html#tmpfile">tmpfile()</a> and the co-process gets its input from a <i>producer</i> (or sends its output to a <i>consumer</i>) via this fifo. With a <i>producer</i> / <i>consumer</i> pair a temporary file will be used to capture <i>cmd</i> output, and the <i>consumer</i> reads input from this file.</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>Fifos can be used in a sub-shell only if <a href="_centauri_bash_ext.html#tmpfile">tmpfile()</a> was initialized by the main process.</div>
</div>
<div class='def-row'>
<div class='def-label'>Errors:</div>
<div class='def-block'>Error handling in co-processes is challenging. If error handling is not disabled via <b>&quot;-e -&quot;</b> then <b>syspipe</b> registers and clears a handler for SIGPIPE. Because of this and the bash restrictions on <b>coproc</b>, this function cannot (or should not) be invoked recursively.</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>The default handler reports an error after SIGPIPE or when <i>cmd</i> returns an error. A custom error handler can be provided (like <b>&quot;-e quit&quot;</b> for a silent termination). Here an implementation example:</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-text'><pre>pip_error() {
    if [ <b>&quot;$1&quot;</b> = &apos;STATUS&apos; ] ; then
        error <b>-p</b> $<b>&quot;command failed (status %s): %s&quot;</b> <b>&quot;$2&quot;</b> <b>&quot;$3&quot;</b>
    else
        error <b>-p</b> $<b>&quot;command failed (%s): %s&quot;</b> <b>&quot;$1&quot;</b> <b>&quot;$3&quot;</b>
    fi
    <b>CEN_SYSPIPE</b>=                        # tell producer to stop
 }</pre></div>
</div>
<div class='def-row'>
<div class='def-label'>Examples:</div>
<div class='def-text'>(1) fifo: send data through a pager<pre>producer() {
    for ((i=0 ; i&lt;100i0; i++)) ; do
       [ <b>-z</b> <b>&quot;$CEN_SYSPIPE&quot;</b> ] &amp;&amp; break   # stop after SIGPIPE error
       echo <b>&quot;Hello $i&quot;</b>
    done 2&gt;/dev/null                    # hide SIGPIPE error message
}
<b>syspipe</b> <b>-o</b> producer <b>--</b> less <b>-R</b> <b>-F</b> <b>-X</b></pre></div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-text'>(2) fifo: faking coproc (uses a pipe and a temporary file)<pre><b>syspipe</b> <b>-o</b> producer <b>-a</b> result <b>--</b> mycommand</pre></div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-text'>(3) coproc: run external command (tr), capture program output<pre>local linp=<b>&quot;Hi there!&quot;</b> lout
<b>syspipe</b> <b>-x</b> <b>-o</b> <b>&quot;echo $linp&quot;</b> <b>-d</b> <b>&quot;read -r lout&quot;</b> <b>--</b> tr [:lower:] [:upper:]
quit <b>&quot;$lout&quot;</b></pre></div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-text'>(4) coproc: in this example _input/_output run in the caller&apos;s context<pre>worker() {  local file ; read <b>-r</b> file &amp;&amp; system <b>-e</b> <b>-p</b> <b>-z</b> cat <b>&quot;$file&quot;</b> ; }
input()  {  echo <b>&quot;$farg&quot;</b> ; }
output() {  local line ; while read <b>-r</b> line ; do echo <b>&quot;$line&quot;</b> ; done ; }
local farg=<b>&quot;/etc/fstab&quot;</b>
<b>syspipe</b> <b>-x</b> <b>-o</b> input <b>-d</b> output <b>-n</b> <b>--</b> worker</pre></div>
</div>
<div class='def-row'>
<div class='def-label'>Remarks:</div>
<div class='def-block'>The implementation allows nested calles to coproc from sub-shells and calls involving pipes from the master shell (otherwise pipes would not be removed on termination). If these conditions are not met, the script is aborted.</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>Variable <b>CEN_SYSPIPE</b> contains the pipe handle(s). The variable can also serve as a condition for the <i>producer</i> to stop (the error handler clears SIGPIPE).</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>It might alse be a good idea to run <b>&quot;context -t +&quot;</b> to catch keyboard interrupts. Especially for any <i>cmd</i> that executes for long time or creates a lot of output.</div>
</div>
</section>
</article>
<div class='def-break'></div>
<nav><div class='nav-row'>
<div class='nav-left'><a href='_centauri_bash_mnt.html'>[&lt;&lt; previous]</a></div>
<div class='nav-mid'><a href='#top'>[Top of Page]</a></div>
<div class='nav-mid'><a href='reference.html#top'>[Reference]</a></div>
<div class='nav-right'><a href='_centauri_bash_pro.html'>[next &gt;&gt;]</a></div>
</div></nav>
</body></html>
