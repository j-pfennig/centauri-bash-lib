<!DOCTYPE html>
<html><head><meta charset='UTF-8'></meta>
<title>centaurihelp ─ _centauri_bash_xtr</title>
<link rel='stylesheet' type='text/css' href='default.css'></link>
<script type='text/javascript' src='default.js'></script>
</head><body onload='initialize("_centauri_bash_xtr")'><article id='top'>
<nav><div class='nav-row'>
<div class='nav-left'><a href='_centauri_bash_xml.html'>[&lt;&lt; previous]</a></div>
<div class='nav-mid'><a href='content.html#top'>[Content]</a></div>
<div class='nav-mid'><a href='reference.html#top'>[Reference]</a></div>
<div class='nav-right'></div>
</div></nav>
<section id='section-1'>
<div id='_centauri_bash_xtr' class='item-module'>
<span>Module</span><span> - </span><span>_centauri_bash_xtr</span><span> - </span><span><a href="index.html">centauri-bash-lib</a>: Self-extractor for standalone scripts</span></div>
<div class='def-row'>
<div class='def-label'>Call:</div>
<div class='def-text'>. <b>_centauri_bash_xtr</b> [<b>-d</b>] [<b>-n</b>]</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'><a href="_centauri_bash_lib.html#embed">embed()</a> should be used to load the module before calling <a href="_centauri_bash_lib.html#main">main()</a>. The module has no public functions, extraction starts when the module is loaded.</div>
</div>
<div class='def-row'>
<div class='def-label'>Options:</div>
<div class='def-text'><b>-d</b>  enable debug output
<b>-n</b>  do not self-extract</div>
</div>
<div class='def-row'>
<div class='def-label'>Remarks:</div>
<div class='def-block'>A self-extraction script is a completely normal script that embeds this module. The script code should end whith something like <b>&quot;main &quot;</b>$@<b>&quot; ; quit&quot;</b> so that bash will never try to read input behind this line. So any type of data can follow. The data section used here starts with a marker line. The decoder re-reads the script file and skips all lines in the input until it reaches the marker line:</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-text'>  <b>!!!DATA!!!</b></div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>The marker is followed by any sequence of:</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-text'>  # create folder (comment lines are ignored)
  <b>d</b> path
  # make symlink
  <b>l</b> target link
  # create a file followed by quoted data lines up to an empty line
  <b>f</b> <i>path</i> [<i>mode</i>]
  <b>&apos;</b><i>data</i><b>&apos;</b> ...</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>Self-extraction stops a the end of file or after a stop marker line:</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-text'>  <b>!!!STOP!!!</b></div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>Sometimes it might be possible or neccessary to encapsulate data in an (unused) here document:</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'><pre># start a here document to hide data from bash interpretation:
: &lt;&lt;!!!END!!!
!!!DATA!!!
# ...
# terminate self-extract data:
!!!STOP!!!
# end of here document:
!!!END!!!</pre></div>
</div>
<div class='def-row'>
<div class='def-label'>Runtime:</div>
<div class='def-block'>The embedded data is extracted at runtime into a cache folder. When the cache data is current, the extraction step is skipped. Use <a href="centauribuilder.html">centauribuilder</a> to encode/attach or decode/list packed runtime data, and <a href="uglify.html">uglify</a> to build self-extracting standalone scripts.</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>The self-extraction process itself is simple. The <a href="uglify.html">uglify</a> tool, when invoked with option <b>--extract</b>, adds an <b>embed -m _centauri_bash_xtr</b> statement prior to calling <a href="_centauri_bash_lib.html#main">main()</a>. Only if the extracted runtime contains an <b>LC_MESSAGE</b> folder for the current locale, the script has to be reloaded to make translations work. This is done by sourcing the script (<b>CEN_XTR_RUNTIME</b> is set as a flag to avoid recursion).</div>
</div>
<div class='def-row'>
<div class='def-label'>Remarks:</div>
<div class='def-block'>The data format is ASCII mixed with hex values for non-ASCII bytes. A &apos;.&apos; character is used to represent a &apos;\x&apos; sequence (and the &apos;.&apos; is encoded as hex). A few more substitutions are made so that any data line can be passed to <b>printf</b> as format string. The format is fast and easy to decode and is great for ASCII data. But binary data can take up to three times the origninal size.</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>Copyright Dr. J. Pfennig (c) 2022</div>
</div>
</section>
<section id='section-2'>
<div id='standalone' class='item-topic'>
<span>Topic</span><span> - </span><span>Standalone</span><span> - </span><span>Making standalone scripts that use <a href="index.html">centauri-bash-lib</a> modules</span></div>
<div class='def-row'>
<div class='def-label'>General:</div>
<div class='def-block'><b>Standalone</b> scripts allow to be used without installing the library.</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-text'>Three flavours are supported:</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-text'>  • package       simple self contained script, no localization
  • portable      self-extracting, allows localization and extra files
  • archive       tar file, needs un-tar into a runtime folder</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>Scripts are written and tested as usual and later converted into a standalone flavour. The high level tool to do this work is <a href="centauribuilder.html">centauribuilder</a> which runs all neccessary low level tools.</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>The <b>package</b> and <b>portable</b> flavours use <a href="uglify.html">uglify</a> to create packaged scripts whereas <b>archive</b> uses the unmodified script.</div>
</div>
<div class='def-row'>
<div class='def-label'>Package:</div>
<div class='def-block'>Packaging is acomplished be slightly modifying the script startup and by adding uglified module sources behind the script. This works fine in most cases, although the script size grows. The script itself is not uglified to allow analysis and modifications.</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>Dynamic module loading does not really work in standalone mode, but is simulated. All used modules must be included in the packed file. For most modules this works automatically by analysing the library options of <a href="_centauri_bash_lib.html">_centauri_bash_lib</a> and by searching for <b>&quot;embed -m&quot;</b> or <b>&quot;embed -c&quot;</b> statements (<b>&quot;embed -r -m&quot;</b> is ignored).</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>Some modules may need to be added manually. The <a href="_centauri_bash_usr.html">_centauri_bash_usr</a> debug support module can helpfull as it lists the loaded modules at exit.</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-text'>&gt; <b>$CEN_ROOT/library/uglify</b> <b>--output</b>=my-script.package my-script
&gt; <b>my-script.package</b> <b>--help</b></div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>The generated output defines <b>&quot;CEN_PACKAGE=1&quot;</b> to allow script code to detect standalone mode.</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>The tool autodetects module dependencies via <b>_centauri_bash_lib</b> and <b>&quot;embed -m&quot;</b>. Others must be added explicitly at the command line or by using code like this:</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-text'><pre>embed <b>-c</b> _centauri_bash_xml         # do not load, add as dependency</pre></div>
</div>
<div class='def-row'>
<div class='def-label'>Portable:</div>
<div class='def-block'>The <b>portable</b> flavour uses a simplistic self-extract format that allows extraction without any external commands, see <a href="_centauri_bash_xtr.html">_centauri_bash_xtr</a>. The <a href="centauribuilder.html">centauribuilder</a> program can be used to create and analyze self-extract data.</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-text'>&gt; <b>centauribuilder</b> add apps my-script <b>--</b> build
&gt; apps/<b>my-script.portable</b> <b>--help</b></div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>The <b>portable</b> flavour is the <a href="centauribuilder.html">centauribuilder</a> default project type. In addition to the example command line you will have to create any tanslations (the <a href="l10n-tool.html">l10n-tool</a> is run as needed) and to add any extra files.</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>In the uglified script file a data section follows the script code. This is possible because bash only interprets text as needed, so it will not attempt to interpret the data. The data itself is not binary, it is still possible to edit the script code.</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>When invoked with <b>--extractor</b> the <a href="uglify.html">uglify</a> command arranges that <a href="_centauri_bash_xtr.html">_centauri_bash_xtr</a> is loaded after script start. On the first run a folder in the user&apos;s cache is created and is populated with extracted data. Also on the 1st run and if the script is localized, the script will reload. All further invokations use the cached data.</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-block'>The variable <b>CEN_XTR_RUNTIME</b> contains the path of the cached runtime folder, which should be the same as <b>CEN_ROOT</b>.</div>
</div>
<div class='def-row'>
<div class='def-label'>Archive:</div>
<div class='def-block'>Here the user must un-tar the archive which just unpacks a runtime folder that contains the script and the related data files.</div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-text'>&gt; tar -taf my-script.runtime.tgz
&gt; <b>my-script-runtime/my-script</b> <b>--help</b></div>
</div>
<div class='def-break'></div>
<div class='def-row'>
<div class='def-empty'></div>
<div class='def-text'>The <a href="centauribuilder.html">centauribuilder</a> program can be used to create the tar archive.</div>
</div>
</section>
</article>
<div class='def-break'></div>
<nav><div class='nav-row'>
<div class='nav-left'><a href='_centauri_bash_xml.html'>[&lt;&lt; previous]</a></div>
<div class='nav-mid'><a href='#top'>[Top of Page]</a></div>
<div class='nav-mid'><a href='reference.html#top'>[Reference]</a></div>
<div class='nav-right'></div>
</div></nav>
</body></html>
